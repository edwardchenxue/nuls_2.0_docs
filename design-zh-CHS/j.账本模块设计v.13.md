# 账本模块设计文档

[TOC]

## 一、总体描述

### 1.1 模块概述

#### 1.1.1 为什么要有《账本模块》

> 账本模块是区块链的数据中枢，所有账户的余额、交易都保存在账本模块中,
  每一个全网节点上都会保存一个全网账本，保证了数据的完整、公开、透明,同时保证了数据不可篡改、可追溯

#### 1.1.2 《账本模块》要做什么

> 为组装交易提供数据支撑,验证交易的合法性，如:是否有充足的余额，是否重复支付(双花)

#### 1.1.3 《账本模块》在系统中的定位

> 账本模块是数据中枢，它不依赖任何业务模块,其他模块按需依赖它。
#### 1.1.4 《账本模块》中名词解释
- 交易的随机数（nonce）
  - nonce：与此地址发送的交易数量相等的标量值，或者，对于具有关联代码的帐户，表示此帐户创建的合约数量。
  - 严格地说，nonce是始发地址的一个属性（它只在发送地址的上下文中有意义）。但是，该nonce并未作为账户状态的一部分显式存储在区块链中。相反，它是根据来源于此地址的已确认交易的数量动态计算的。
  - nonce值也用于防止帐户余额的错误计算。例如，假设一个账户有10个以太的余额，并且签署了两个交易，都花费6个ether，分别具有nonce 1和nonce 2。这两笔交易中哪一笔有效？在以太坊这样的分布式系统中，节点可能无序地接收交易。nonce强制任何地址的交易按顺序处理，不管间隔时间如何，无论节点接收到的顺序如何。这样，所有节点都会计算相同的余额。支付6以太币的交易将被成功处理，账户余额减少到4 ether。无论什么时候收到，所有节点都认为与带有nonce 2的交易无效。如果一个节点先收到nonce 2的交易，会持有它，但在收到并处理完nonce 1的交易之前不会验证它。
  - 使用nonce确保所有节点计算相同的余额，并正确地对交易进行排序，相当于比特币中用于防止“双重支付”的机制。但是，因为以太坊跟踪账户余额并且不会单独跟踪独立的币（在比特币中称为UTXO），所以只有在账户余额计算错误时才会发生“双重支付”。nonce机制可以防止这种情况发生。
  
### 1.2 架构图
![event-bus-module](image/eventbus/event-bus-module.png)

- 账本模块主要含2部分交互逻辑：
  - 与系统核心模块的微服务注册与服务信息获取。
  - 与其他基础模块间的事件消息创建、订阅、转发管理。

## 二、功能设计

### 2.1 功能架构图
![ledger-functions.png](image/ledger/ledger-functions.png)

### 2.2 模块服务
#### 2.2.1 账本模块的系统服务
![ledger-service.png](image/ledger/ledger-service.png)

> 账本模块提供的RPC的接口调用,详细接口请参照接口设计部分。

#### 2.2.2 修改系统运行参数

> 只依赖核心系统，核心系统可以对事件模块系统的启动，停止，参数修改等，

### 2.3 模块内部功能

> 模块内部工能主要包含,资产管理,获取账户地址余额和nonce,交易记录保存，验证交易。

- 资产管理
  - 账户的总资产
  - 可用资产
  - 冻结资产
  - 多资产情况，需要加入chainId.
- 获取账户地址余额和nonce
  - 获取账户地址余额
  - 获取账户地址nonce(该nonce是一个基于零的计数器，意味着第一个交易的nonce是0.)
- 交易记录保存
  - 钱包创建的待确认交易
  - 已确认的交易是否存在账本中？
  - 在交易中，还需要考虑一个from多个to合并成一笔交易。
- 验证交易
  - 双花验证(nonce机制阻止双重支付)
  - 交易创建者验证,验证交易发出者是否拥有足够的余额,验证交易创建者的nonce是否合法
  - 连续交易验证
- 功能接口管理(rpc)
  - 提供给其他模块使用的rpc接口
### 2.4 账本流程
### 2.4.1 交易验证流程
![trx-validate-flow.png](image/ledger/trx-validate-flow.png)

## 三、接口设计

### 3.1 模块接口
#### 3.1.1 查询用户余额
> cmd: getBalance

##### 参数说明 (request body)

```json
{
  "cmd": "getBalance",
  "minVersion": "1.0",
  "params":[
    "chainId",//链Id
    "assetsId",//资产id
    "0x407d73d8a49eeb85d32cf465507dd71d507100c1"//要查询余额的地址
  ]
}
```
##### 返回值说明 (response content)

```json
{
  "version": "1.0",
  "code": 0,
  "msg": "response message.",//失败时的信息
  "result": {
    "balance": "100000000" //1NULS=10^8Na
  }
}
```

#### 3.1.2 getNonce
> cmd: getNonce

##### 参数说明 (request body)

```json
{
"cmd": "getNonce",
"minVersion": "1.0",
"params":[
  "app.nuls.network.bandwidth", //topic 事件主题
  "moduleId" //moduleId订阅者模块id
  ]
}
```

##### 返回值说明：(response content)

```json
{
  "version": "1.0",
  "code": 0, //操作码
  "msg": "reponse message.",//失败时的信息
  "result": {
  }
}
```

## 四、事件说明

> 不依赖任何事件

## 五、协议

### 5.1 网络通讯协议

无

### 5.2 交易协议

## 六、模块配置
### 6.1 配置说明

### 6.2 模块依赖关系

- 内核模块
  - 模块注册
  - 模块注销
  - 模块状态上报（心跳）
  - 服务接口数据获取及定时更新

## 七、Java特有的设计

> 核心对象类定义,存储数据结构，......

## 八、补充内容

> 上面未涉及的必须的内容

